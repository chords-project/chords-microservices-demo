apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: jaeger
    app.kubernetes.io/component: all-in-one
    app.kubernetes.io/name: jaeger
  name: jaeger
spec:
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      annotations:
        prometheus.io/port: "16686"
        prometheus.io/scrape: "true"
      labels:
        app: jaeger
        app.kubernetes.io/component: all-in-one
        app.kubernetes.io/name: jaeger
    spec:
      containers:
        - env:
            - name: COLLECTOR_OTLP_ENABLED
              value: "true"
          image: jaegertracing/all-in-one
          livenessProbe:
            httpGet:
              path: /
              port: 16686
          name: jaeger
          ports:
            - containerPort: 16686
              protocol: TCP
            - containerPort: 4317
              protocol: TCP
          resources:
            limits:
              cpu: 200m
              memory: 300Mi
            requests:
              cpu: 50m
              memory: 180Mi
      tolerations:
        - effect: NoSchedule
          key: kubernetes.io/arch
          operator: Equal
          value: arm64
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: jaeger
    app.kubernetes.io/component: query
    app.kubernetes.io/name: jaeger
  name: jaeger-query
spec:
  ports:
    - name: query-http
      port: 16686
      protocol: TCP
      targetPort: 16686
  selector:
    app: jaeger
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: jaeger
    app.kubernetes.io/component: collector
    app.kubernetes.io/name: jaeger
  name: jaeger-collector
spec:
  ports:
    - name: jaeger-collector-otlp
      port: 4317
      protocol: TCP
      targetPort: 4317
  selector:
    app.kubernetes.io/component: all-in-one
    app.kubernetes.io/name: jaeger
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: jaeger
  name: jaeger-query-external
spec:
  ports:
    - name: http
      port: 16686
      targetPort: 16686
  selector:
    app: jaeger
  type: LoadBalancer
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: adservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cartservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: checkoutservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: currencyservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: emailservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: frontend
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: paymentservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: productcatalogservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: recommendationservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: shippingservice
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: adservice
  name: adservice
spec:
  ports:
    - name: grpc
      port: 9555
      targetPort: 9555
  selector:
    app: adservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: cartservice
  name: cartservice
spec:
  ports:
    - name: grpc
      port: 7070
      targetPort: 7070
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: cartservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: checkoutservice
  name: checkoutservice
spec:
  ports:
    - name: grpc
      port: 5050
      targetPort: 5050
  selector:
    app: checkoutservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: currencyservice
  name: currencyservice
spec:
  ports:
    - name: grpc
      port: 7000
      targetPort: 7000
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: currencyservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: emailservice
  name: emailservice
spec:
  ports:
    - name: grpc
      port: 5000
      targetPort: 8080
  selector:
    app: emailservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: frontend
  name: frontend
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
    - name: choral-rest-api
      port: 8081
      targetPort: 8081
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: frontend
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: frontend
  name: frontend-external
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: frontend
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: paymentservice
  name: paymentservice
spec:
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: paymentservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: productcatalogservice
  name: productcatalogservice
spec:
  ports:
    - name: grpc
      port: 3550
      targetPort: 3550
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: productcatalogservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: recommendationservice
  name: recommendationservice
spec:
  ports:
    - name: grpc
      port: 8080
      targetPort: 8080
  selector:
    app: recommendationservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: redis-cart
  name: redis-cart
spec:
  ports:
    - name: tcp-redis
      port: 6379
      targetPort: 6379
  selector:
    app: redis-cart
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: shippingservice
  name: shippingservice
spec:
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: shippingservice
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: adservice
  name: adservice
spec:
  selector:
    matchLabels:
      app: adservice
  template:
    metadata:
      labels:
        app: adservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "9555"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/adservice:sic-jss-268-g89174230@sha256:e2d2fb07f4f6b63997387c68da59595c280f467f8cd7b2da463370a78dcc4957
          livenessProbe:
            grpc:
              port: 9555
          name: server
          ports:
            - containerPort: 9555
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 9555
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: adservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: cartservice
  name: cartservice
spec:
  selector:
    matchLabels:
      app: cartservice
  template:
    metadata:
      labels:
        app: cartservice
    spec:
      containers:
        - env:
            - name: CHORAL_CART
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: CHORAL_PRODUCT_CATALOG
              value: productcatalogservice:5401
            - name: CHORAL_SHIPPING
              value: shippingservice:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/cartservice-sidecar:sic-jss-268-g89174230@sha256:d923f71aeaefb941d180679ac34bcbf7d7e829effe8c7cbd0f7a54770ae0206e
          livenessProbe:
            grpc:
              port: 5401
          name: cart-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: REDIS_ADDR
              value: redis-cart:6379
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/cartservice:sic-jss-268-g89174230@sha256:559d20308cecd435e3f680493a069337488829e671a096d353e0841051194a23
          livenessProbe:
            grpc:
              port: 7070
          name: cart-server
          ports:
            - containerPort: 7070
          resources:
            limits:
              cpu: 300m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 7070
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: cartservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: checkoutservice
  name: checkoutservice
spec:
  selector:
    matchLabels:
      app: checkoutservice
  template:
    metadata:
      labels:
        app: checkoutservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "5050"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
            - name: PRODUCT_CATALOG_SERVICE_ADDR
              value: productcatalogservice:3550
            - name: SHIPPING_SERVICE_ADDR
              value: shippingservice:50051
            - name: PAYMENT_SERVICE_ADDR
              value: paymentservice:50051
            - name: EMAIL_SERVICE_ADDR
              value: emailservice:5000
            - name: CURRENCY_SERVICE_ADDR
              value: currencyservice:7000
            - name: CART_SERVICE_ADDR
              value: cartservice:7070
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/checkoutservice:sic-jss-268-g89174230@sha256:2e4fec56c86d279c3d0c096f3dfdd535a7dd1dcab7da7a619ca5e9a852403a04
          livenessProbe:
            grpc:
              port: 5050
          name: server
          ports:
            - containerPort: 5050
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5050
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: checkoutservice
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: currencyservice
  name: currencyservice
spec:
  selector:
    matchLabels:
      app: currencyservice
  template:
    metadata:
      labels:
        app: currencyservice
    spec:
      containers:
        - env:
            - name: CHORAL_CURRENCY
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/currencyservice-sidecar:sic-jss-268-g89174230@sha256:9872fd0d12a41ba9ddec54b818c00b937934394fd991c3d17a95e798babbf4d6
          livenessProbe:
            grpc:
              port: 5401
          name: currency-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "7000"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/currencyservice:sic-jss-268-g89174230@sha256:0cf854ad0b1452131c3d8e5b82229f4f83de1976696095671c5d7e1fbebd50ed
          livenessProbe:
            grpc:
              port: 7000
          name: currency-server
          ports:
            - containerPort: 7000
              name: grpc
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 7000
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: currencyservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: emailservice
  name: emailservice
spec:
  selector:
    matchLabels:
      app: emailservice
  template:
    metadata:
      annotations:
        debug.cloud.google.com/config: '{}'
      labels:
        app: emailservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "8080"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/emailservice:sic-jss-268-g89174230@sha256:836e63c64ce003cda0355afd2b8d24bee93a0f07de6e07475323e1eca99d6316
          livenessProbe:
            grpc:
              port: 8080
          name: server
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: emailservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: frontend
  name: frontend
spec:
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      annotations:
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
      labels:
        app: frontend
    spec:
      containers:
        - env:
            - name: CHORAL_CART
              value: cartservice:5401
            - name: CHORAL_CURRENCY
              value: currencyservice:5401
            - name: CHORAL_SHIPPING
              value: shippingservice:5401
            - name: CHORAL_PAYMENT
              value: paymentservice:5401
            - name: CHORAL_FRONTEND
              value: 0.0.0.0:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/frontend-sidecar:sic-jss-268-g89174230@sha256:6abc0bbe85ea371618bcd83d463188f90ec847a581217b9619d298e73afccafe
          livenessProbe:
            httpGet:
              path: /ping
              port: 8081
          name: frontend-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            httpGet:
              path: /ping
              port: 8081
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "8080"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
            - name: PRODUCT_CATALOG_SERVICE_ADDR
              value: productcatalogservice:3550
            - name: CURRENCY_SERVICE_ADDR
              value: currencyservice:7000
            - name: CART_SERVICE_ADDR
              value: cartservice:7070
            - name: RECOMMENDATION_SERVICE_ADDR
              value: recommendationservice:8080
            - name: SHIPPING_SERVICE_ADDR
              value: shippingservice:50051
            - name: CHECKOUT_SERVICE_ADDR
              value: checkoutservice:5050
            - name: AD_SERVICE_ADDR
              value: adservice:9555
            - name: SHOPPING_ASSISTANT_SERVICE_ADDR
              value: shoppingassistantservice:80
            - name: ENABLE_PROFILER
              value: "0"
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/frontend:sic-jss-268-g89174230@sha256:18cc3ae93978fcbd50821ce063ad88d9f2894b852e64b49188783cb2ea61730d
          livenessProbe:
            httpGet:
              httpHeaders:
                - name: Cookie
                  value: shop_session-id=x-liveness-probe
              path: /_healthz
              port: 8080
            initialDelaySeconds: 10
          name: frontend-server
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            httpGet:
              httpHeaders:
                - name: Cookie
                  value: shop_session-id=x-readiness-probe
              path: /_healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: frontend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: paymentservice
  name: paymentservice
spec:
  selector:
    matchLabels:
      app: paymentservice
  template:
    metadata:
      labels:
        app: paymentservice
    spec:
      containers:
        - env:
            - name: CHORAL_PAYMENT
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/paymentservice-sidecar:sic-jss-268-g89174230@sha256:155390b79e8a6b546c7e8e2ab1aaa0e05c76729743906c33627f1f6c92c6d0e4
          livenessProbe:
            grpc:
              port: 5401
          name: payment-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "50051"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/paymentservice:sic-jss-268-g89174230@sha256:0bd6364b358646be3e3b506be3125cfff9bbfe74e307f5f315f21af0396c9404
          livenessProbe:
            grpc:
              port: 50051
          name: payment-server
          ports:
            - containerPort: 50051
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 50051
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: paymentservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: productcatalogservice
  name: productcatalogservice
spec:
  selector:
    matchLabels:
      app: productcatalogservice
  template:
    metadata:
      labels:
        app: productcatalogservice
    spec:
      containers:
        - env:
            - name: CHORAL_PRODUCT_CATALOG
              value: 0.0.0.0:5401
            - name: CHORAL_CURRENCY
              value: currencyservice:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/productcatalog-sidecar:sic-jss-268-g89174230@sha256:8289cef91866300569378cab6faec8afddefd20af00b51c949664048ef510bd5
          livenessProbe:
            grpc:
              port: 5401
          name: productcatalog-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "3550"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/productcatalogservice:sic-jss-268-g89174230@sha256:46ce8940084872889a8f09f020b41086db42205c01cef108855bdd5580730cd7
          livenessProbe:
            grpc:
              port: 3550
          name: productcatalog-server
          ports:
            - containerPort: 3550
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 3550
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: productcatalogservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: recommendationservice
  name: recommendationservice
spec:
  selector:
    matchLabels:
      app: recommendationservice
  template:
    metadata:
      annotations:
        debug.cloud.google.com/config: '{}'
      labels:
        app: recommendationservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "8080"
            - name: PRODUCT_CATALOG_SERVICE_ADDR
              value: productcatalogservice:3550
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/recommendationservice:sic-jss-268-g89174230@sha256:2c60cd32c0e9892dedef836302216a2cf050c7e39c6da7a35d3b2402f2bd167f
          livenessProbe:
            grpc:
              port: 8080
          name: server
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 200m
              memory: 450Mi
            requests:
              cpu: 50m
              memory: 220Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: recommendationservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: redis-cart
  name: redis-cart
spec:
  selector:
    matchLabels:
      app: redis-cart
  template:
    metadata:
      labels:
        app: redis-cart
    spec:
      containers:
        - image: redis:alpine
          livenessProbe:
            periodSeconds: 5
            tcpSocket:
              port: 6379
          name: redis
          ports:
            - containerPort: 6379
          readinessProbe:
            periodSeconds: 5
            tcpSocket:
              port: 6379
          resources:
            limits:
              cpu: 125m
              memory: 256Mi
            requests:
              cpu: 70m
              memory: 200Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          volumeMounts:
            - mountPath: /data
              name: redis-data
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
        - emptyDir: {}
          name: redis-data
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: shippingservice
  name: shippingservice
spec:
  selector:
    matchLabels:
      app: shippingservice
  template:
    metadata:
      labels:
        app: shippingservice
    spec:
      containers:
        - env:
            - name: CHORAL_SHIPPING
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: CHORAL_CURRENCY
              value: currencyservice:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/shippingservice-sidecar:sic-jss-268-g89174230@sha256:b1ed47c93662bf42b551da28569fa135dd2d5e112cc19efc5761c887790c9f79
          livenessProbe:
            grpc:
              port: 5401
          name: shipping-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "50051"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/shippingservice:sic-jss-268-g89174230@sha256:a8db0a74b7346f37483a640ac9cec23b6f71fafd2fb734562567c2ef4ea02158
          livenessProbe:
            grpc:
              port: 50051
          name: shipping-server
          ports:
            - containerPort: 50051
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 50051
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: shippingservice
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: jaeger
    app.kubernetes.io/component: all-in-one
    app.kubernetes.io/name: jaeger
  name: jaeger
spec:
  selector:
    matchLabels:
      app: jaeger
  template:
    metadata:
      annotations:
        prometheus.io/port: "16686"
        prometheus.io/scrape: "true"
      labels:
        app: jaeger
        app.kubernetes.io/component: all-in-one
        app.kubernetes.io/name: jaeger
    spec:
      containers:
        - env:
            - name: COLLECTOR_OTLP_ENABLED
              value: "true"
          image: jaegertracing/all-in-one
          livenessProbe:
            httpGet:
              path: /
              port: 16686
          name: jaeger
          ports:
            - containerPort: 16686
              protocol: TCP
            - containerPort: 4317
              protocol: TCP
          resources:
            limits:
              cpu: 200m
              memory: 300Mi
            requests:
              cpu: 50m
              memory: 180Mi
      tolerations:
        - effect: NoSchedule
          key: kubernetes.io/arch
          operator: Equal
          value: arm64
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: jaeger
    app.kubernetes.io/component: query
    app.kubernetes.io/name: jaeger
  name: jaeger-query
spec:
  ports:
    - name: query-http
      port: 16686
      protocol: TCP
      targetPort: 16686
  selector:
    app: jaeger
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: jaeger
    app.kubernetes.io/component: collector
    app.kubernetes.io/name: jaeger
  name: jaeger-collector
spec:
  ports:
    - name: jaeger-collector-otlp
      port: 4317
      protocol: TCP
      targetPort: 4317
  selector:
    app.kubernetes.io/component: all-in-one
    app.kubernetes.io/name: jaeger
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: jaeger
  name: jaeger-query-external
spec:
  ports:
    - name: http
      port: 16686
      targetPort: 16686
  selector:
    app: jaeger
  type: LoadBalancer
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: adservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cartservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: checkoutservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: currencyservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: emailservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: frontend
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: paymentservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: productcatalogservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: recommendationservice
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: shippingservice
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: adservice
  name: adservice
spec:
  ports:
    - name: grpc
      port: 9555
      targetPort: 9555
  selector:
    app: adservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: cartservice
  name: cartservice
spec:
  ports:
    - name: grpc
      port: 7070
      targetPort: 7070
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: cartservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: checkoutservice
  name: checkoutservice
spec:
  ports:
    - name: grpc
      port: 5050
      targetPort: 5050
  selector:
    app: checkoutservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: currencyservice
  name: currencyservice
spec:
  ports:
    - name: grpc
      port: 7000
      targetPort: 7000
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: currencyservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: emailservice
  name: emailservice
spec:
  ports:
    - name: grpc
      port: 5000
      targetPort: 8080
  selector:
    app: emailservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: frontend
  name: frontend
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
    - name: choral-rest-api
      port: 8081
      targetPort: 8081
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: frontend
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: frontend
  name: frontend-external
spec:
  ports:
    - name: http
      port: 80
      targetPort: 8080
  selector:
    app: frontend
  type: LoadBalancer
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: paymentservice
  name: paymentservice
spec:
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: paymentservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: productcatalogservice
  name: productcatalogservice
spec:
  ports:
    - name: grpc
      port: 3550
      targetPort: 3550
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: productcatalogservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: recommendationservice
  name: recommendationservice
spec:
  ports:
    - name: grpc
      port: 8080
      targetPort: 8080
  selector:
    app: recommendationservice
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: redis-cart
  name: redis-cart
spec:
  ports:
    - name: tcp-redis
      port: 6379
      targetPort: 6379
  selector:
    app: redis-cart
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: shippingservice
  name: shippingservice
spec:
  ports:
    - name: grpc
      port: 50051
      targetPort: 50051
    - name: choral-sidecar
      port: 5401
      targetPort: 5401
  selector:
    app: shippingservice
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: adservice
  name: adservice
spec:
  selector:
    matchLabels:
      app: adservice
  template:
    metadata:
      labels:
        app: adservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "9555"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/adservice:sic-jss-268-g89174230@sha256:e2d2fb07f4f6b63997387c68da59595c280f467f8cd7b2da463370a78dcc4957
          livenessProbe:
            grpc:
              port: 9555
          name: server
          ports:
            - containerPort: 9555
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 9555
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: adservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: cartservice
  name: cartservice
spec:
  selector:
    matchLabels:
      app: cartservice
  template:
    metadata:
      labels:
        app: cartservice
    spec:
      containers:
        - env:
            - name: CHORAL_CART
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: CHORAL_PRODUCT_CATALOG
              value: productcatalogservice:5401
            - name: CHORAL_SHIPPING
              value: shippingservice:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/cartservice-sidecar:sic-jss-268-g89174230@sha256:d923f71aeaefb941d180679ac34bcbf7d7e829effe8c7cbd0f7a54770ae0206e
          livenessProbe:
            grpc:
              port: 5401
          name: cart-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: REDIS_ADDR
              value: redis-cart:6379
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/cartservice:sic-jss-268-g89174230@sha256:559d20308cecd435e3f680493a069337488829e671a096d353e0841051194a23
          livenessProbe:
            grpc:
              port: 7070
          name: cart-server
          ports:
            - containerPort: 7070
          resources:
            limits:
              cpu: 300m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 7070
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: cartservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: checkoutservice
  name: checkoutservice
spec:
  selector:
    matchLabels:
      app: checkoutservice
  template:
    metadata:
      labels:
        app: checkoutservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "5050"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
            - name: PRODUCT_CATALOG_SERVICE_ADDR
              value: productcatalogservice:3550
            - name: SHIPPING_SERVICE_ADDR
              value: shippingservice:50051
            - name: PAYMENT_SERVICE_ADDR
              value: paymentservice:50051
            - name: EMAIL_SERVICE_ADDR
              value: emailservice:5000
            - name: CURRENCY_SERVICE_ADDR
              value: currencyservice:7000
            - name: CART_SERVICE_ADDR
              value: cartservice:7070
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/checkoutservice:sic-jss-268-g89174230@sha256:2e4fec56c86d279c3d0c096f3dfdd535a7dd1dcab7da7a619ca5e9a852403a04
          livenessProbe:
            grpc:
              port: 5050
          name: server
          ports:
            - containerPort: 5050
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5050
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: checkoutservice
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: currencyservice
  name: currencyservice
spec:
  selector:
    matchLabels:
      app: currencyservice
  template:
    metadata:
      labels:
        app: currencyservice
    spec:
      containers:
        - env:
            - name: CHORAL_CURRENCY
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/currencyservice-sidecar:sic-jss-268-g89174230@sha256:9872fd0d12a41ba9ddec54b818c00b937934394fd991c3d17a95e798babbf4d6
          livenessProbe:
            grpc:
              port: 5401
          name: currency-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "7000"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/currencyservice:sic-jss-268-g89174230@sha256:0cf854ad0b1452131c3d8e5b82229f4f83de1976696095671c5d7e1fbebd50ed
          livenessProbe:
            grpc:
              port: 7000
          name: currency-server
          ports:
            - containerPort: 7000
              name: grpc
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 7000
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: currencyservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: emailservice
  name: emailservice
spec:
  selector:
    matchLabels:
      app: emailservice
  template:
    metadata:
      annotations:
        debug.cloud.google.com/config: '{}'
      labels:
        app: emailservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "8080"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/emailservice:sic-jss-268-g89174230@sha256:836e63c64ce003cda0355afd2b8d24bee93a0f07de6e07475323e1eca99d6316
          livenessProbe:
            grpc:
              port: 8080
          name: server
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: emailservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: frontend
  name: frontend
spec:
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      annotations:
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
      labels:
        app: frontend
    spec:
      containers:
        - env:
            - name: CHORAL_CART
              value: cartservice:5401
            - name: CHORAL_CURRENCY
              value: currencyservice:5401
            - name: CHORAL_SHIPPING
              value: shippingservice:5401
            - name: CHORAL_PAYMENT
              value: paymentservice:5401
            - name: CHORAL_FRONTEND
              value: 0.0.0.0:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/frontend-sidecar:sic-jss-268-g89174230@sha256:6abc0bbe85ea371618bcd83d463188f90ec847a581217b9619d298e73afccafe
          livenessProbe:
            httpGet:
              path: /ping
              port: 8081
          name: frontend-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            httpGet:
              path: /ping
              port: 8081
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "8080"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
            - name: PRODUCT_CATALOG_SERVICE_ADDR
              value: productcatalogservice:3550
            - name: CURRENCY_SERVICE_ADDR
              value: currencyservice:7000
            - name: CART_SERVICE_ADDR
              value: cartservice:7070
            - name: RECOMMENDATION_SERVICE_ADDR
              value: recommendationservice:8080
            - name: SHIPPING_SERVICE_ADDR
              value: shippingservice:50051
            - name: CHECKOUT_SERVICE_ADDR
              value: checkoutservice:5050
            - name: AD_SERVICE_ADDR
              value: adservice:9555
            - name: SHOPPING_ASSISTANT_SERVICE_ADDR
              value: shoppingassistantservice:80
            - name: ENABLE_PROFILER
              value: "0"
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/frontend:sic-jss-268-g89174230@sha256:18cc3ae93978fcbd50821ce063ad88d9f2894b852e64b49188783cb2ea61730d
          livenessProbe:
            httpGet:
              httpHeaders:
                - name: Cookie
                  value: shop_session-id=x-liveness-probe
              path: /_healthz
              port: 8080
            initialDelaySeconds: 10
          name: frontend-server
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 100m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            httpGet:
              httpHeaders:
                - name: Cookie
                  value: shop_session-id=x-readiness-probe
              path: /_healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: frontend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: paymentservice
  name: paymentservice
spec:
  selector:
    matchLabels:
      app: paymentservice
  template:
    metadata:
      labels:
        app: paymentservice
    spec:
      containers:
        - env:
            - name: CHORAL_PAYMENT
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/paymentservice-sidecar:sic-jss-268-g89174230@sha256:155390b79e8a6b546c7e8e2ab1aaa0e05c76729743906c33627f1f6c92c6d0e4
          livenessProbe:
            grpc:
              port: 5401
          name: payment-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "50051"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/paymentservice:sic-jss-268-g89174230@sha256:0bd6364b358646be3e3b506be3125cfff9bbfe74e307f5f315f21af0396c9404
          livenessProbe:
            grpc:
              port: 50051
          name: payment-server
          ports:
            - containerPort: 50051
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 50051
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: paymentservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: productcatalogservice
  name: productcatalogservice
spec:
  selector:
    matchLabels:
      app: productcatalogservice
  template:
    metadata:
      labels:
        app: productcatalogservice
    spec:
      containers:
        - env:
            - name: CHORAL_PRODUCT_CATALOG
              value: 0.0.0.0:5401
            - name: CHORAL_CURRENCY
              value: currencyservice:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/productcatalog-sidecar:sic-jss-268-g89174230@sha256:8289cef91866300569378cab6faec8afddefd20af00b51c949664048ef510bd5
          livenessProbe:
            grpc:
              port: 5401
          name: productcatalog-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "3550"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/productcatalogservice:sic-jss-268-g89174230@sha256:46ce8940084872889a8f09f020b41086db42205c01cef108855bdd5580730cd7
          livenessProbe:
            grpc:
              port: 3550
          name: productcatalog-server
          ports:
            - containerPort: 3550
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 3550
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: productcatalogservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: recommendationservice
  name: recommendationservice
spec:
  selector:
    matchLabels:
      app: recommendationservice
  template:
    metadata:
      annotations:
        debug.cloud.google.com/config: '{}'
      labels:
        app: recommendationservice
    spec:
      containers:
        - env:
            - name: PORT
              value: "8080"
            - name: PRODUCT_CATALOG_SERVICE_ADDR
              value: productcatalogservice:3550
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/recommendationservice:sic-jss-268-g89174230@sha256:2c60cd32c0e9892dedef836302216a2cf050c7e39c6da7a35d3b2402f2bd167f
          livenessProbe:
            grpc:
              port: 8080
          name: server
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: 200m
              memory: 450Mi
            requests:
              cpu: 50m
              memory: 220Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: recommendationservice
      terminationGracePeriodSeconds: 5
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: redis-cart
  name: redis-cart
spec:
  selector:
    matchLabels:
      app: redis-cart
  template:
    metadata:
      labels:
        app: redis-cart
    spec:
      containers:
        - image: redis:alpine
          livenessProbe:
            periodSeconds: 5
            tcpSocket:
              port: 6379
          name: redis
          ports:
            - containerPort: 6379
          readinessProbe:
            periodSeconds: 5
            tcpSocket:
              port: 6379
          resources:
            limits:
              cpu: 125m
              memory: 256Mi
            requests:
              cpu: 70m
              memory: 200Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          volumeMounts:
            - mountPath: /data
              name: redis-data
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      volumes:
        - emptyDir: {}
          name: redis-data
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: shippingservice
  name: shippingservice
spec:
  selector:
    matchLabels:
      app: shippingservice
  template:
    metadata:
      labels:
        app: shippingservice
    spec:
      containers:
        - env:
            - name: CHORAL_SHIPPING
              value: 0.0.0.0:5401
            - name: CHORAL_FRONTEND
              value: frontend:5401
            - name: CHORAL_CURRENCY
              value: currencyservice:5401
            - name: JAEGER_ENDPOINT
              value: http://jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/shippingservice-sidecar:sic-jss-268-g89174230@sha256:b1ed47c93662bf42b551da28569fa135dd2d5e112cc19efc5761c887790c9f79
          livenessProbe:
            grpc:
              port: 5401
          name: shipping-sidecar
          ports:
            - containerPort: 5401
          resources:
            limits:
              cpu: 300m
              memory: 300Mi
            requests:
              cpu: 100m
              memory: 180Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 5401
            initialDelaySeconds: 10
            periodSeconds: 5
        - env:
            - name: PORT
              value: "50051"
            - name: DISABLE_PROFILER
              value: "1"
            - name: ENABLE_TRACING
              value: "1"
            - name: COLLECTOR_SERVICE_ADDR
              value: jaeger-collector:4317
          image: europe-west1-docker.pkg.dev/chords-microservice-444208/webshop-repo/shippingservice:sic-jss-268-g89174230@sha256:a8db0a74b7346f37483a640ac9cec23b6f71fafd2fb734562567c2ef4ea02158
          livenessProbe:
            grpc:
              port: 50051
          name: shipping-server
          ports:
            - containerPort: 50051
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
          startupProbe:
            failureThreshold: 100
            grpc:
              port: 50051
            initialDelaySeconds: 10
            periodSeconds: 5
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: shippingservice
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: loadgenerator
  name: loadgenerator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loadgenerator
  template:
    metadata:
      annotations:
        debug.cloud.google.com/config: '{}'
        sidecar.istio.io/rewriteAppHTTPProbers: "true"
      labels:
        app: loadgenerator
    spec:
      containers:
        - env:
            - name: FRONTEND_ADDR
              value: frontend:80
            - name: USERS
              value: "10"
          image: loadgenerator
          name: main
          ports:
            - containerPort: 8089
              protocol: TCP
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 300m
              memory: 256Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: false
      initContainers:
        - command:
            - /bin/sh
            - -exc
            - |
              MAX_RETRIES=12
              RETRY_INTERVAL=10
              for i in $(seq 1 $MAX_RETRIES); do
                echo "Attempt $i: Pinging frontend: ${FRONTEND_ADDR}..."
                STATUSCODE=$(wget --server-response http://${FRONTEND_ADDR} 2>&1 | awk '/^  HTTP/{print $2}')
                if [ $STATUSCODE -eq 200 ]; then
                    echo "Frontend is reachable."
                    exit 0
                fi
                echo "Error: Could not reach frontend - Status code: ${STATUSCODE}"
                sleep $RETRY_INTERVAL
              done
              echo "Failed to reach frontend after $MAX_RETRIES attempts."
              exit 1
          env:
            - name: FRONTEND_ADDR
              value: frontend:80
          image: busybox:latest
          name: frontend-check
          resources:
            limits:
              cpu: 100m
              memory: 150Mi
            requests:
              cpu: 50m
              memory: 50Mi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            privileged: false
            readOnlyRootFilesystem: true
      restartPolicy: Always
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      serviceAccountName: loadgenerator
      terminationGracePeriodSeconds: 5
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: loadgenerator
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: loadgenerator
  name: loadgenerator
spec:
  ports:
    - name: http
      port: 8089
      targetPort: 8089
  selector:
    app: loadgenerator
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: loadgenerator
  name: loadgenerator-external
spec:
  ports:
    - name: http
      port: 8089
      targetPort: 8089
  selector:
    app: loadgenerator
  type: LoadBalancer
